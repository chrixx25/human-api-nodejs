const express=require("express"),router=express.Router(),Human=require("../models/human"),Joi=require("joi"),getHuman=async(req,res,next)=>{let human;if(24!==req.params.id.length)return res.status(404).send("Invalid id.");try{if(human=await Human.findById(req.params.id),!human)return res.status(404).send("Cannot find human.")}catch(error){return res.status(500).send(`Error ${error}.`)}res.human=human,next()},validateHuman=human=>{const schema=Joi.object({name:Joi.string().required(),email:Joi.string().required()});return schema.validate(human)};router.get("/humans/",async(req,res)=>{try{const human=await Human.find();res.json(human)}catch(error){return res.status(500).send(`Error ${error}.`)}}),router.get("/human/:id",getHuman,(req,res)=>{res.json(res.human)}),router.post("/human/",async(req,res)=>{const{error:error}=validateHuman(req.body);if(error)return res.status(400).send(error.details[0].message);try{const{name:name,email:email}=req.body,human_exists=await Human.find({email:email});if(human_exists.length>0)return void res.status(400).send(`Email ${req.body.email} is already exists.`);const human=new Human({name:name,email:email}),new_human=await human.save();res.status(201).json(new_human)}catch(error){res.status(500).send(`Error ${error}.`)}}),router.put("/human/:id",getHuman,async(req,res)=>{const{error:error}=validateHuman(req.body,res.human);if(error)return res.status(400).send(error.details[0].message);try{const{name:name,email:email}=req.body,human=res.human;if(email!==human.email){const human_exists=await Human.find({email:email});if(human_exists.length>0)return void res.status(400).send(`Email ${req.body.email} is already exists.`)}human.name=name,human.email=email;const updated_human=await human.save();res.json(updated_human)}catch(error){res.status(500).send(`Error ${error}.`)}}),router.delete("/human/:id",getHuman,async(req,res)=>{try{const deleted_human=res.human.name;await res.human.remove(),res.send(`${deleted_human} is deleted.`)}catch(error){return res.status(500).send(`Error ${error}.`)}}),module.exports=router;